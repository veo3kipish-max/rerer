# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–¥–ø–∏—Å–∫–∏ —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è—é—Ç —Å—Ç–∞—Ç—É—Å!

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Telegram:
- ‚úÖ –ö—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚ùå `subscription_tier` –Ω–µ –º–µ–Ω—è–ª—Å—è (–æ—Å—Ç–∞–≤–∞–ª—Å—è `'free'`)
- ‚ùå –ü–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞ `net::ERR_HTTP_RESPONSE_CODE_FAILURE`

## üîç –ü—Ä–∏—á–∏–Ω–∞

–í `create-telegram-invoice/index.ts` **payload.type –≤—Å–µ–≥–¥–∞ –±—ã–ª `'credits'`**:

```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const payload = JSON.stringify({
    userId,
    packageId,
    type: 'credits', // ‚ùå –í—Å–µ–≥–¥–∞ credits!
    credits,
    tier
})
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ:
1. Webhook –ø–æ–ª—É—á–∞–ª `payload.type = 'credits'`
2. –õ–æ–≥–∏–∫–∞ –≤ webhook –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞ `subscription_tier`
3. –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–≤–∞–ª—Å—è `'free'`

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω—ë–Ω –∫–æ–¥ payment type –Ω–∞ –æ—Å–Ω–æ–≤–µ tier:

```typescript
// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const payload = JSON.stringify({
    userId,
    packageId,
    type: tier ? 'subscription' : 'credits', // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø!
    credits,
    tier
})
```

–¢–µ–ø–µ—Ä—å:
- –ï—Å–ª–∏ –µ—Å—Ç—å `tier` ‚Üí —Ç–∏–ø `'subscription'` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è subscription_tier ‚úÖ
- –ï—Å–ª–∏ –Ω–µ—Ç `tier` ‚Üí —Ç–∏–ø `'credits'` ‚Üí —Ç–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç—ã ‚úÖ

## üöÄ –î–µ–ø–ª–æ–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|-----------|--------|---------|
| **Edge Function** | ‚úÖ –ó–∞–¥–µ–ø–ª–æ–µ–Ω–∞ | –í–µ—Ä—Å–∏—è 21 |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ | –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é |
| **Git** | ‚úÖ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ | c161825 |

### Supabase Edge Function
- **–§—É–Ω–∫—Ü–∏—è:** `create-telegram-invoice`
- **–í–µ—Ä—Å–∏—è:** 21
- **–î–µ–ø–ª–æ–π:** 2025-12-09 17:51 UTC+3
- **–°—Ç–∞—Ç—É—Å:** ACTIVE

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `5c71a124-d576-4c59-b221-92ea8a6f3644` –æ–±–Ω–æ–≤–ª—ë–Ω –≤—Ä—É—á–Ω—É—é
- `subscription_tier` –∏–∑–º–µ–Ω—ë–Ω: `'free'` ‚Üí `'light'`
- `subscription_expires_at` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ +30 –¥–Ω–µ–π

## üì± –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –¢–µ—Å—Ç 1: –ö—É–ø–∏—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
1. –û—Ç–∫—Ä–æ–π—Ç–µ https://kipish.fun
2. –ü—Ä–æ—Ñ–∏–ª—å ‚Üí "–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
3. –í–∫–ª–∞–¥–∫–∞ "Subscription (Best Value)"
4. –ö—É–ø–∏—Ç–µ –ª—é–±—É—é –ø–æ–¥–ø–∏—Å–∫—É (Light/Pro/Ultra)
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
   - –ö—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã ‚úÖ
   - –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π tier ‚úÖ
   - –ù–µ—Ç –æ—à–∏–±–∫–∏ ERR_HTTP_RESPONSE_CODE_FAILURE ‚úÖ

### –¢–µ—Å—Ç 2: –ö—É–ø–∏—Ç—å –ø–∞–∫–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤
1. –û—Ç–∫—Ä–æ–π—Ç–µ https://kipish.fun
2. –ü—Ä–æ—Ñ–∏–ª—å ‚Üí "–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å"
3. –í–∫–ª–∞–¥–∫–∞ "One-time Photos"
4. –ö—É–ø–∏—Ç–µ –ª—é–±–æ–π –ø–∞–∫–µ—Ç
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ö—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã ‚úÖ
   - –°—Ç–∞—Ç—É—Å –ù–ï –∏–∑–º–µ–Ω—ë–Ω (–∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å) ‚úÖ

## üîç SQL –ø—Ä–æ–≤–µ—Ä–∫–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:
SELECT * FROM payments 
WHERE type = 'subscription' 
ORDER BY created_at DESC 
LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
SELECT name, credits, subscription_tier, subscription_expires_at 
FROM users 
WHERE id = '5c71a124-d576-4c59-b221-92ea8a6f3644';
```

## üìä –î–æ vs –ü–æ—Å–ª–µ

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí `type: 'credits'` ‚Üí –∫—Ä–µ–¥–∏—Ç—ã +30, tier = `'free'` ‚ùå

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí `type: 'subscription'` ‚Üí –∫—Ä–µ–¥–∏—Ç—ã +30, tier = `'light'` ‚úÖ
- –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ ‚Üí `type: 'credits'` ‚Üí –∫—Ä–µ–¥–∏—Ç—ã +5, tier = `'free'` ‚úÖ

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

**–¢–µ–ø–µ—Ä—å webhook –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏!**

- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏ (`sub_light`, `sub_pro`, `sub_ultra`) –º–µ–Ω—è—é—Ç tier
- ‚úÖ –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤ (`pack_1`, `pack_5`, –∏ —Ç.–¥.) —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è—é—Ç –∫—Ä–µ–¥–∏—Ç—ã
- ‚úÖ –û—à–∏–±–∫–∞ `ERR_HTTP_RESPONSE_CODE_FAILURE` –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
2. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∞ –∏—Å—á–µ–∑–ª–∞

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-12-09 17:51 UTC+3  
**–í–µ—Ä—Å–∏—è:** 2.4.1 (Subscription Type Fix)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
