# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Payoneer

–≠—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Payoneer Checkout –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ AI Photo Studio.

## –û–±–∑–æ—Ä

Payoneer Checkout –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É —Å –ø–æ–º–æ—â—å—é –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –∫–∞—Ä—Ç, –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã.

## –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Payoneer

1. **–°–æ–∑–¥–∞–π—Ç–µ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç Payoneer**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://www.payoneer.com/
   - –ù–∞–∂–º–∏—Ç–µ "Sign Up" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ "Business Account"
   - –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ–æ—Ä–º—É —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∏ –ø—Ä–æ–π–¥–∏—Ç–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é

2. **–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Checkout**
   - –í–æ–π–¥–∏—Ç–µ –≤ https://myaccount.payoneer.com/
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Settings** ‚Üí **Payment Services**
   - –ù–∞–π–¥–∏—Ç–µ **Payoneer Checkout** –∏ –Ω–∞–∂–º–∏—Ç–µ **Enable**
   - –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ

3. **–ü–æ–ª—É—á–∏—Ç–µ API credentials**
   - –í —Ä–∞–∑–¥–µ–ª–µ **Developers** ‚Üí **API Credentials** —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π API –∫–ª—é—á
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:
     - **Program ID** (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã)
     - **API Username**
     - **API Password**
   
   > ‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –•—Ä–∞–Ω–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏! –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∏—Ö –≤ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supabase Edge Function

–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Payoneer API –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.

### 2.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Supabase CLI

```bash
npm install -g supabase
```

### 2.2 –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

```bash
supabase functions new create-payoneer-payment
```

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/functions/create-payoneer-payment/index.ts` –∏ –¥–æ–±–∞–≤—å—Ç–µ:

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { amount, currency, description, userId, packageId } = await req.json()
    
    const programId = Deno.env.get('PAYONEER_PROGRAM_ID')
    const apiUsername = Deno.env.get('PAYONEER_API_USERNAME')
    const apiPassword = Deno.env.get('PAYONEER_API_PASSWORD')
    
    if (!programId || !apiUsername || !apiPassword) {
      throw new Error('Payoneer credentials not configured')
    }

    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const paymentId = `${userId}_${packageId}_${Date.now()}`
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º Basic Auth
    const authString = btoa(`${apiUsername}:${apiPassword}`)
    
    // –°–æ–∑–¥–∞–µ–º checkout —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ Payoneer API
    const response = await fetch(`https://api.payoneer.com/v2/programs/${programId}/charges`, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${authString}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        client_reference_id: paymentId,
        currency: currency || 'UAH',
        amount: amount * 100, // –í –∫–æ–ø–µ–π–∫–∞—Ö
        description: description,
        statement_soft_descriptor: 'AI Photo Studio',
        return_url: `${req.headers.get('origin')}/payment/success`,
        cancel_url: `${req.headers.get('origin')}/payment/cancel`,
      }),
    })

    const data = await response.json()
    
    if (!response.ok) {
      throw new Error(data.message || 'Payoneer API error')
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ –≤ Supabase
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2')
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    await supabaseAdmin
      .from('payments')
      .insert({
        user_id: userId,
        type: packageId.startsWith('pack_') ? 'credits' : 'subscription',
        amount: amount,
        currency: currency || 'UAH',
        payoneer_charge_id: data.charge_id,
        status: 'pending'
      })

    return new Response(JSON.stringify({
      checkout_url: data.checkout_url,
      charge_id: data.charge_id
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })

  } catch (error) {
    console.error('Error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 400,
    })
  }
})
```

### 2.3 –°–æ–∑–¥–∞–Ω–∏–µ Webhook –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

```bash
supabase functions new payoneer-webhook
```

–û—Ç–∫—Ä–æ–π—Ç–µ `supabase/functions/payoneer-webhook/index.ts`:

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

serve(async (req) => {
  try {
    const payload = await req.json()
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å webhook (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
    const signature = req.headers.get('payoneer-signature')
    // TODO: –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Payoneer
    
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    if (payload.event_type === 'charge.succeeded') {
      const chargeId = payload.data.charge_id
      const clientRefId = payload.data.client_reference_id
      
      // –ù–∞—Ö–æ–¥–∏–º –ø–ª–∞—Ç–µ–∂ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      const { data: payment } = await supabaseAdmin
        .from('payments')
        .select('*')
        .eq('payoneer_charge_id', chargeId)
        .single()

      if (!payment) {
        throw new Error('Payment not found')
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
      await supabaseAdmin
        .from('payments')
        .update({
          status: 'completed',
          completed_at: new Date().toISOString()
        })
        .eq('id', payment.id)

      // –ù–∞—á–∏—Å–ª—è–µ–º –∫—Ä–µ–¥–∏—Ç—ã –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
      if (payment.type === 'credits') {
        const { data: user } = await supabaseAdmin
          .from('users')
          .select('credits')
          .eq('id', payment.user_id)
          .single()

        if (user) {
          await supabaseAdmin
            .from('users')
            .update({ credits: user.credits + payment.credits })
            .eq('id', payment.user_id)
        }
      } else if (payment.type === 'subscription') {
        const expiryDate = new Date()
        expiryDate.setDate(expiryDate.getDate() + 30)
        
        await supabaseAdmin
          .from('users')
          .update({
            subscription_tier: payment.tier,
            subscription_expires_at: expiryDate.toISOString()
          })
          .eq('id', payment.user_id)
      }

      console.log(`Payment ${payment.id} completed successfully`)
    }

    return new Response(JSON.stringify({ received: true }), {
      headers: { 'Content-Type': 'application/json' },
      status: 200,
    })

  } catch (error) {
    console.error('Webhook error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { 'Content-Type': 'application/json' },
      status: 400,
    })
  }
})
```

### 2.4 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í –ø–∞–Ω–µ–ª–∏ Supabase (**Settings** ‚Üí **Edge Functions**) –¥–æ–±–∞–≤—å—Ç–µ:

```
PAYONEER_PROGRAM_ID=your_program_id
PAYONEER_API_USERNAME=your_api_username
PAYONEER_API_PASSWORD=your_api_password
```

### 2.5 –î–µ–ø–ª–æ–π —Ñ—É–Ω–∫—Ü–∏–π

```bash
supabase functions deploy create-payoneer-payment --no-verify-jwt
supabase functions deploy payoneer-webhook --no-verify-jwt
```

## –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Frontend

–û–±–Ω–æ–≤–∏—Ç–µ `components/PricingModal.tsx`:

```typescript
import { supabase } from '../services/supabaseClient';

const handleBuyPackage = async (pkg: any) => {
    if (isGuest) {
        alert('Please log in to purchase credits');
        return;
    }

    try {
        setIsProcessing(true);
        setProcessingMessage('Creating payment session...');

        // –í—ã–∑—ã–≤–∞–µ–º Edge Function –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        const { data, error } = await supabase.functions.invoke('create-payoneer-payment', {
            body: {
                amount: pkg.price,
                currency: 'UAH',
                description: `${pkg.label || pkg.title} - AI Photo Studio`,
                userId: currentUser!.dbUserId,
                packageId: pkg.id
            }
        });

        if (error) throw error;
        if (!data.checkout_url) throw new Error('No checkout URL returned');

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã Payoneer
        window.location.href = data.checkout_url;

    } catch (error: any) {
        console.error('Payment error:', error);
        setIsProcessing(false);
        alert(error.message || 'Failed to create payment. Please try again.');
    }
};
```

## –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ Payoneer

1. –í–æ–π–¥–∏—Ç–µ –≤ https://myaccount.payoneer.com/
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Developers** ‚Üí **Webhooks**
3. –ù–∞–∂–º–∏—Ç–µ **Add Endpoint**
4. –í–≤–µ–¥–∏—Ç–µ URL –≤–∞—à–µ–≥–æ webhook:
   ```
   https://<your-project-ref>.functions.supabase.co/payoneer-webhook
   ```
5. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - `charge.succeeded`
   - `charge.failed`
   - `charge.refunded`
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ **Signing Secret** (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)

## –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

Payoneer –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç sandbox –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ credentials –∏–∑ Payoneer Dashboard
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:
   - **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: `4111 1111 1111 1111`
   - **–û—Ç–∫–ª–æ–Ω–µ–Ω–∞**: `4000 0000 0000 0002`
   - CVV: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã
   - Expiry: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞

### Production —Ä–µ–∂–∏–º

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ó–∞–º–µ–Ω–∏—Ç–µ sandbox credentials –Ω–∞ production
2. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Supabase
3. –ü–µ—Ä–µ–¥–µ–ª–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏

## –ü–æ—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã

```
1. User clicks "Pay with Payoneer"
   ‚Üì
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç create-payoneer-payment Edge Function
   ‚Üì
3. Edge Function —Å–æ–∑–¥–∞–µ—Ç charge —á–µ—Ä–µ–∑ Payoneer API
   ‚Üì
4. User –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ checkout_url Payoneer
   ‚Üì
5. User –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
   ‚Üì
6. Payoneer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
   ‚Üì
7. payoneer-webhook –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã
   ‚Üì
8. User –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ return_url
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
- –•—Ä–∞–Ω–∏—Ç–µ API credentials —Ç–æ–ª—å–∫–æ –≤ Supabase Edge Functions (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–ø–∏—Å—å webhook
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

‚ùå **–ß–µ–≥–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ credentials –≤ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –ù–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ –¥–∞–Ω–Ω—ã–º –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ù–µ –Ω–∞—á–∏—Å–ª—è–π—Ç–µ –∫—Ä–µ–¥–∏—Ç—ã –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è webhook

## –ö–æ–º–∏—Å—Å–∏–∏

Payoneer –≤–∑–∏–º–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –∫–∞–∂–¥—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
- **–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç—ã**: ~3.5% + —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—Ç–∞
- **–õ–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã**: ~2.9% + —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—Ç–∞

–£—Ç–æ—á–Ω–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –≤ –≤–∞—à–µ–º Payoneer –∞–∫–∫–∞—É–Ω—Ç–µ.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Payoneer API**: https://developers.payoneer.com/
- **Support**: https://myaccount.payoneer.com/support
- **–°—Ç–∞—Ç—É—Å API**: https://status.payoneer.com/

## –ì–æ—Ç–æ–≤–æ! üéâ

–¢–µ–ø–µ—Ä—å –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ Payoneer.
